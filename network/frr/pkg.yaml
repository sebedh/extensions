name: frr
variant: scratch
shell: /toolchain/bin/bash
dependencies:
  - stage: base
  - image: ghcr.io/sebedh/alpine-builder:v1
steps:
  - sources: 
      - url: https://github.com/FRRouting/frr/archive/refs/tags/frr-{{ .FRR_VERSION }}.tar.gz
        destination: frr.tar.gz
        sha256: 8a6b0e0fa1e89493ba84cf176674e55c7a814821fd02a7188095b76c37c3935f
        sha512: 1ee9d17ef3b85c5c10df624a6560bcacb2b5daa3d6231e457f06d9eb6e5ccf375064a46e809d851c23cb6daf7a4299d1f25be589992ef729e80f9bad41a8d7f7
    prepare:
      - |
        sed -i 's#$VERSION#{{ .VERSION }}#' /pkg/manifest.yaml

      - |
        tar -xzf frr.tar.gz --strip-component=1
        rm frr.tar.gz
      - |
        export PKG_CONFIG_PATH="/usr/lib/pkgconfig"
        ./bootstrap.sh
        ./configure \
           --enable-user=frr \
           --enable-group=frr \
           --prefix=/usr/local \
           --sysconfdir=/usr/local/etc/frr \
           --localstatedir=/var/run/frr \
           --sbindir=/usr/local/lib/frr \
           --with-yangmodelsdir=/usr/local/share/yang \
           --disable-doc \
           --disable-pimd \
           --disable-ripd \
           --disable-ripngd \
           --disable-ospfd \
           --disable-ospf6d \
           --disable-ldpd \
           --disable-nhrpd \
           --disable-eigrpd \
           --disable-babeld \
           --disable-vrrpd \
           --disable-pbrd \
           --disable-bfdd \
           --disable-ospfapi \
           --disable-ospfclient \
           --disable-isisd \
           --disable-fabricd \
           --disable-irdp \
           --disable-rtadv \
           --disable-backtrace \
           --disable-snmp
    build:
      - |
        make -j $(nproc) all

    install:
      - |
        export DESTDIR=/rootfs
        make install

        containerRoot=/rootfs/usr/local/lib/containers/frr
        mkdir -p "$containerRoot"/{etc,bin,sbin,usr/local/bin,usr/local/include,usr/local/lib,usr/local/share}
        mv /rootfs/usr/local/lib/lib* "$containerRoot/usr/local/lib/"
        mv /rootfs/usr/local/lib/frr "$containerRoot/usr/local/lib/"
        mv /rootfs/usr/local/share "$containerRoot/usr/local/"
        mv /rootfs/usr/local/include "$containerRoot/usr/local/"

        # tini docker-start
        cp /sbin/tini "$containerRoot/sbin/"
        cp /pkg/files/docker-start "$containerRoot/"
        cp /pkg/files/group "$containerRoot/etc/"
        cp /pkg/files/passwd "$containerRoot/etc/"
        cp /bin/sh "$containerRoot/bin/"
        cp /bin/rm "$containerRoot/bin/"
        cp /usr/bin/dirname "$containerRoot/usr/bin/"

        # path
        frrPath="$containerRoot/usr/local/lib/frr"
        sed -i "s#/bin/bash#/usr/local/bin/bash#g" "$frrPath/frrcommon.sh"
        sed -i "s#/bin/bash#/usr/local/bin/bash#g" "$frrPath/frrinit.sh"
        sed -i "s#/bin/bash#/usr/local/bin/bash#g" "$frrPath/watchfrr.sh"
        sed -i "s#/bin/bash#/usr/local/bin/bash#g" "$frrPath/frr"

        mkdir -p "$containerRoot/var/tmp/frr"
        mkdir -p "$containerRoot/var/run/frr"
        touch "$continerRoot/var/run/frr/{staticd,bgpd,zebra}.pid"
        chown -R 101:123 "$containerRoot/var/tmp/frr"
        chown -R 101:123 "$containerRoot/var/run/frr"
  - sources:
      - url: https://github.com/bminor/bash/archive/refs/tags/bash-5.1.tar.gz
        destination: bash.tar.gz
        sha256: 94debafc8ae597cfed3fda5c99a8311e66534f1bbb3ec86194c9ed29613fb075
        sha512: 2234ab9e7ec61afee6e278c36207748009fbc50504d3e43506edec46fa39fb6097c819d9b84f51893f30135bdffcf2aeb7760e5f8d86b26644fe2a9ecc8c5791
    prepare:
      - |
        tar -xzf bash.tar.gz --strip-component=1
        ./configure \
          --prefix=/usr/local \
          --bindir=/usr/local/bin \
          --libdir=/usr/local/lib \
          --includedir=/usr/local/include \
          --disable-nls \
          --enable-readline \
          --without-bash-malloc

    build:
      - |
        make y.tab.c && make builtins/libbuiltins.a && make
    install:
      - |
        make install DESTDIR=/rootfs

        containerRoot=/rootfs/usr/local/lib/containers/frr
        mv /rootfs/usr/local/lib/bash "$containerRoot/usr/local/lib/"
        mv /rootfs/usr/local/lib/pkgconfig "$containerRoot/usr/local/lib/"
        mv /rootfs/usr/local/share/doc/bash "$containerRoot/usr/local/share/doc/"
        mv /rootfs/usr/local/share/info "$containerRoot/usr/local/share/info"
        mv /rootfs/usr/local/share/man "$containerRoot/usr/local/share/man"
        mv /rootfs/usr/local/include/bash "$containerRoot/usr/local/include"
        mv /usr/lib/libncurses* "$containerRoot/usr/local/lib/"
        mv /usr/lib/libcurses* "$containerRoot/usr/local/lib/"
        mv /usr/lib/libreadline* "$containerRoot/usr/local/lib/"
        mv /usr/lib/libhistory* "$containerRoot/usr/local/lib/"
        mv /usr/lib/libyang* "$containerRoot/usr/local/lib/"
        mv /usr/lib/libcap* "$containerRoot/usr/local/lib/"
        mv /usr/lib/libpcre* "$containerRoot/usr/local/lib/"
        mv /usr/include/ncurses* "$containerRoot/usr/local/include/"
        mv /usr/include/curses* "$containerRoot/usr/local/include/"
        mv /usr/include/readline "$containerRoot/usr/local/include/"
        cp /rootfs/usr/local/bin/bash "$containerRoot/usr/local/bin/bash"

        mkdir "$containerRoot/usr/bin"
        cp /usr/bin/install "$containerRoot/usr/bin/"
        cp /bin/grep "$containerRoot/usr/bin/"

        rm -rf /rootfs/usr/local/bin
        rm -rf /rootfs/usr/local/etc
        rm -rf /rootfs/usr/local/lib/frr
        rm -rf /rootfs/usr/local/sbin
        rm -rf /rootfs/usr/local/share
        rm -rf /rootfs/usr/local/include

finalize:
  - from: /rootfs
    to: /rootfs
  - from: /pkg/manifest.yaml
    to: /
  - from: /pkg/frr.yaml
    to: /rootfs/usr/local/etc/containers/frr.yaml
